<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"whitetail-o.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Lecture 13 Ray Tracinga). vs. Rasterization 光栅化难以表现全局（global）效果，如  （软）阴影（Soft shadows） 光线反弹超过一次（Glossy reflection） Indirect illumination（间接光照）    Rasterization is fast, but quality is relatively low；">
<meta property="og:type" content="article">
<meta property="og:title" content="Games101-13-16 RayTracing">
<meta property="og:url" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/index.html">
<meta property="og:site_name" content="WhiteTail&#39;s Blog">
<meta property="og:description" content="Lecture 13 Ray Tracinga). vs. Rasterization 光栅化难以表现全局（global）效果，如  （软）阴影（Soft shadows） 光线反弹超过一次（Glossy reflection） Indirect illumination（间接光照）    Rasterization is fast, but quality is relatively low；">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/vs.Rsaterization.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayTracing00.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/EmissionTheory.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/CastingRay.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/CastingRay01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RecursiveRayTracing.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithSphere.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithSphere01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithImplicitSurface.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithTriangleMesh.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/PlaneEquation.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/PlaneEquation01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MollerTrumboreAlgorithm.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/BoundingVolumes.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/AABB_BoundingBox.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayIntersection_with_AABB.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/AA_reason.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/UniformSpatialPartitions00.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/UniformSpatialPartitions.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/SpatialPartitioningEx.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/KD_Tree_Pre_Processing.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/KD_Tree_Traversing.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/BVH.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/BVH_P_Code.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/SpatialvsObjectPartitions.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RIR.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RadiantIntensity.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/SolidAngle.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/SolidAngle_D01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/SolidAngle_D02.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/W_dirVect.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Isotropic.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Irradiance.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/LambertsCosLaw.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/IrradianceFalloff.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Radiance.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/IncidentRadiance.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/ExitingRadiance.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/IrradianceVS_radiance.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/BRDF.png">
<meta property="og:image" content="https://www.zhihu.com/equation?tex=%5Cvec%7Bl%7D">
<meta property="og:image" content="https://www.zhihu.com/equation?tex=%5Cvec%7Bl%7D">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/TheReflectionEquation.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/TheReflectionEquation02.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RenderingEquation.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/ReflectionEquation.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RenderingEquation_und.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RenderEq_asIntegralEq.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RE_linearOp.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Appro_RE_linear.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RayTracing_byREQL.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Comp_DI.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Comp_GI_2bounce.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Comp_GI_4bounce.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/Comp_GI_16bounce.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/PDF.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/ExpectedValue.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MonteCarlo00.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MonteCarlo01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MonteCarlo_Uniform.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MonteCarlo_Uniform02.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/WS_Glossy.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/WS_Diffuse.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI_Fx.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI_Fx_G.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_Pcode.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_GI.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_GI_P1.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_GI_SPP.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RR.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/RR_Pcode.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_Wasted.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_dA01.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_dA02.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_%E4%BC%98%E5%8C%96_Pcode.png">
<meta property="og:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/MC_%E4%BC%98%E5%8C%96_Pcode02.png">
<meta property="article:published_time" content="2022-10-03T10:15:10.000Z">
<meta property="article:modified_time" content="2023-02-12T13:18:29.194Z">
<meta property="article:author" content="WhiteTail">
<meta property="article:tag" content="Games101">
<meta property="article:tag" content="图形学">
<meta property="article:tag" content="Ray-Tracing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/vs.Rsaterization.png">


<link rel="canonical" href="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/","path":"2022/10/03/Games101_13_16_RayTracing/","title":"Games101-13-16 RayTracing"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Games101-13-16 RayTracing | WhiteTail's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="WhiteTail's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">WhiteTail's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Lecture-13-Ray-Tracing"><span class="nav-text">Lecture 13 Ray Tracing</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#a-vs-Rasterization"><span class="nav-text">a). vs. Rasterization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#b-Basic-Ray-Tracing-Algorithm"><span class="nav-text">b.). Basic Ray-Tracing Algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#b-1-Ray-Casting"><span class="nav-text">b.1). Ray Casting</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#c-Whitted-Style-Ray-Tracing-Recursive-%E9%80%92%E5%BD%92"><span class="nav-text">c). Whitted-Style Ray Tracing(Recursive, 递归)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#c-1-Ray-Surface-Intersection%EF%BC%88%E6%B1%82%E4%BA%A4%E7%82%B9%EF%BC%89"><span class="nav-text">c.1). Ray-Surface Intersection（求交点）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#c-1-1-%E4%B8%8E%E7%90%83%E5%BD%A2%E7%9B%B8%E4%BA%A4%EF%BC%9A"><span class="nav-text">c.1.1). 与球形相交：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-1-2-%E4%B8%8E%E4%B8%89%E8%A7%92%E5%BD%A2%E6%B1%82%E4%BA%A4%EF%BC%9A"><span class="nav-text">c.1.2). 与三角形求交：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-2-Acclerating-Ray-Surface-Intersection"><span class="nav-text">c.2). Acclerating Ray-Surface Intersection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#c-2-1-Axis-Aligned-Bounding-Box-AABB%EF%BC%8C%E8%BD%B4%E5%AF%B9%E9%BD%90%E5%8C%85%E5%9B%B4%E7%9B%92"><span class="nav-text">c.2.1). Axis-Aligned Bounding Box(AABB，轴对齐包围盒)</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lecture-14-amp-15-Ray-Tracing-Acceleration-amp-Radiometry-Light-Transport-amp-Global-Illumination"><span class="nav-text">Lecture 14&amp;15 Ray Tracing(Acceleration &amp; Radiometry; Light Transport &amp; Global Illumination)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#a-Uniform-Spatial-Partitions%EF%BC%88%E7%BB%9F%E4%B8%80%E7%A9%BA%E9%97%B4%E5%88%86%E5%8C%BA%EF%BC%89"><span class="nav-text">a). Uniform Spatial Partitions（统一空间分区）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#b-Spatial-Partition"><span class="nav-text">b). Spatial Partition</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#b-1-KD-Tree"><span class="nav-text">b.1). KD-Tree</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#c-Bounding-Volume-Hierarchy-BVH"><span class="nav-text">c). Bounding Volume Hierarchy (BVH)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#d-Radiometry"><span class="nav-text">d). Radiometry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#d-1-Radiant-Energy-and-Flux-Power"><span class="nav-text">d.1). Radiant Energy and Flux(Power)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-2-Radiant-Intensity-%E8%BE%90%E5%B0%84%E5%BC%BA%E5%BA%A6"><span class="nav-text">d.2). Radiant Intensity(辐射强度)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#d-2-1-Solid-angle"><span class="nav-text">d.2.1). Solid angle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-2-2-%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B"><span class="nav-text">d.2.2). 计算过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-2-3-Irradiance-%E8%BE%90%E7%85%A7%E5%BA%A6"><span class="nav-text">d.2.3). Irradiance(辐照度)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-2-4-Radiance-%E8%BE%90%E4%BA%AE%E5%BA%A6"><span class="nav-text">d.2.4). Radiance(辐亮度)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#c-BRDF-Bidirectional-Reflectance-Distribution-Function"><span class="nav-text">c). BRDF(Bidirectional Reflectance Distribution Function)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#d-Rendering-equation"><span class="nav-text">d). Rendering equation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#d-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">d.1). 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-2-%E7%90%86%E8%A7%A3"><span class="nav-text">d.2). 理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rendering-Equation%E7%9A%84%E7%BA%BF%E6%80%A7%E5%BD%A2%E5%BC%8F%E5%AF%B9%E4%BA%8E%E5%85%89%E8%BF%BD%E7%9A%84%E5%90%AF%E7%A4%BA%EF%BC%9A"><span class="nav-text">Rendering Equation的线性形式对于光追的启示：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#e-Probability"><span class="nav-text">e). Probability</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lecture-16-Ray-Tracing-4-Monte-Carlo-Path-Tracing"><span class="nav-text">Lecture 16 Ray Tracing 4 (Monte Carlo Path Tracing)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#a-Monte-Carlo-Integration"><span class="nav-text">a). Monte Carlo Integration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#b-Paht-Tracing"><span class="nav-text">b). Paht Tracing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#b-1-vs-Whitted-Style-Ray-Tracing"><span class="nav-text">b.1). vs Whitted-Style Ray Tracing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-2-A-Simple-Monte-Carlo-Solution-Direct-illumination"><span class="nav-text">b.2). A Simple Monte Carlo Solution(Direct illumination)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-3-Global-illumination-%E5%8A%A0%E5%85%A5%E9%80%92%E5%BD%92"><span class="nav-text">b.3). Global illumination(加入递归)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#b-3-1-GI-and-problems"><span class="nav-text">b.3.1). GI and problems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-3-2-Russian-Roulette-RR-%E4%BF%84%E7%BD%97%E6%96%AF%E8%BD%AE%E7%9B%98%E8%B5%8C"><span class="nav-text">b.3.2). Russian Roulette(RR, 俄罗斯轮盘赌)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-3-3-%E4%BC%98%E5%8C%96"><span class="nav-text">b.3.3). 优化</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="WhiteTail"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">WhiteTail</p>
  <div class="site-description" itemprop="description">现已有Games101、Games202、百人计划等笔记，后续准备上传DX12、Unity的SRP等笔记。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    相关文章
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2023/02/01/Games202_03_Real-time%20Environment%20Mapping/" rel="bookmark">
        <time class="popular-posts-time">2023-02-01</time>
        <br>
      Games202-3 Real-time Environment Mapping
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2023/02/10/Games202_04_Real-time%20Global%20Illumination(in%203D)/" rel="bookmark">
        <time class="popular-posts-time">2023-02-10</time>
        <br>
      Games202-4 Real-time Global Illumination(in 3D)
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/2022/10/02/Games101_02_04_Math/" rel="bookmark">
        <time class="popular-posts-time">2022-10-02</time>
        <br>
      Games101-2-4 Math
      </a>
    </li>
  </ul>

          </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://whitetail-o.github.io/2022/10/03/Games101_13_16_RayTracing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="WhiteTail">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WhiteTail's Blog">
      <meta itemprop="description" content="现已有Games101、Games202、百人计划等笔记，后续准备上传DX12、Unity的SRP等笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Games101-13-16 RayTracing | WhiteTail's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Games101-13-16 RayTracing
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
  
  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-03 18:15:10" itemprop="dateCreated datePublished" datetime="2022-10-03T18:15:10+08:00">2022-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-12 21:18:29" itemprop="dateModified" datetime="2023-02-12T21:18:29+08:00">2023-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Games101/" itemprop="url" rel="index"><span itemprop="name">Games101</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Lecture-13-Ray-Tracing"><a href="#Lecture-13-Ray-Tracing" class="headerlink" title="Lecture 13 Ray Tracing"></a>Lecture 13 Ray Tracing</h1><h2 id="a-vs-Rasterization"><a href="#a-vs-Rasterization" class="headerlink" title="a). vs. Rasterization"></a>a). vs. Rasterization</h2><ul>
<li><p>光栅化难以表现<strong>全局（global）</strong>效果，如</p>
<ul>
<li>（软）阴影（Soft shadows）</li>
<li>光线反弹<strong>超过一次</strong>（Glossy reflection）</li>
<li>Indirect illumination（间接光照）</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/vs.Rsaterization.png" alt="vs.Rsaterization"></p>
</li>
<li><p>Rasterization is fast, but quality is relatively low；</p>
</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/RayTracing00.png" alt="RayTracing00"></p>
<h2 id="b-Basic-Ray-Tracing-Algorithm"><a href="#b-Basic-Ray-Tracing-Algorithm" class="headerlink" title="b.). Basic Ray-Tracing Algorithm"></a>b.). Basic Ray-Tracing Algorithm</h2><ul>
<li><p><strong>光追中光线的性质：</strong></p>
<ol>
<li>光是沿直线传播的；</li>
<li>光相交时，并不产生干扰；</li>
<li>光从光源出发，传播到眼睛（由于光路可逆，也可是光线从眼睛出发，传播到光源）</li>
</ol>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/EmissionTheory.png" alt="EmissionTheory"></p>
</li>
</ul>
<h3 id="b-1-Ray-Casting"><a href="#b-1-Ray-Casting" class="headerlink" title="b.1). Ray Casting"></a>b.1). Ray Casting</h3><ul>
<li><p><strong>做法：</strong></p>
<ol>
<li>Generate an image by <strong>casting one ray per pixel</strong>;（生成从眼睛出发的光线）</li>
<li>Check for shadows by <strong>sending a ray to the light</strong>;（检查光线投射点是否可传播到光源）</li>
</ol>
</li>
<li><div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/CastingRay.png" height="300px" alt="CastingRay"> <img src="/2022/10/03/Games101_13_16_RayTracing/CastingRay01.png" height="300px" alt="CastingRay01"> </div>

<ul>
<li>光线由眼睛出发，可不再使用深度缓存；</li>
<li>投射点到光源发射<strong>Shadow Ray</strong>，查看该点是否在阴影里（是否对光源可见）；</li>
</ul>
</li>
</ul>
<span id="more"></span>
<h2 id="c-Whitted-Style-Ray-Tracing-Recursive-递归"><a href="#c-Whitted-Style-Ray-Tracing-Recursive-递归" class="headerlink" title="c). Whitted-Style Ray Tracing(Recursive, 递归)"></a>c). Whitted-Style Ray Tracing(Recursive, 递归)</h2><p><img src="/2022/10/03/Games101_13_16_RayTracing/RecursiveRayTracing.png" alt="RecursiveRayTracing"></p>
<ul>
<li><strong>过程：</strong><ul>
<li><strong>生成眼睛到像素a的光线（Primary ray）</strong>，打到第一个与光线<strong>相交</strong>的点；</li>
<li>形成<strong>反射（镜面反射）</strong>和<strong>折射</strong>的光线（<strong>Secondary rays</strong>，之后的都是Secondary rays）；</li>
<li>对每条光线与object的交点做到光源的光线（<strong>Shadow rays</strong>）；</li>
<li>将所有Shadow rays未被阻挡的光线的着色结果相加，即为像素a的着色结果；</li>
</ul>
</li>
</ul>
<h3 id="c-1-Ray-Surface-Intersection（求交点）"><a href="#c-1-Ray-Surface-Intersection（求交点）" class="headerlink" title="c.1). Ray-Surface Intersection（求交点）"></a>c.1). Ray-Surface Intersection（求交点）</h3><h4 id="c-1-1-与球形相交："><a href="#c-1-1-与球形相交：" class="headerlink" title="c.1.1). 与球形相交："></a>c.1.1). 与球形相交：</h4><div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithSphere.png" height="300px" alt="RayIntersectionWithSphere"> <img src="/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithSphere01.png" height="300px" alt="CastingRay01"> </div>

<ul>
<li><strong>推广：</strong>与隐式表面相交<img src="/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithImplicitSurface.png" alt="RayIntersectionWithImplicitSurface"></li>
</ul>
<h4 id="c-1-2-与三角形求交："><a href="#c-1-2-与三角形求交：" class="headerlink" title="c.1.2). 与三角形求交："></a>c.1.2). 与三角形求交：</h4><p><img src="/2022/10/03/Games101_13_16_RayTracing/RayIntersectionWithTriangleMesh.png" alt="RayIntersectionWithTriangleMesh"></p>
<ul>
<li><p><strong>几何上：</strong>判断内外；</p>
<ul>
<li>空间内任意一点为起点做一光线，若该光线与object（封闭）交点数为奇数，则该点在object内；若交点数为奇数，则该点在object外；（缠绕数的奇-偶原则）</li>
</ul>
</li>
<li><p><strong>计算过程：</strong></p>
<ul>
<li><div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/PlaneEquation.png" height="300px" alt="PlaneEquation"> <img src="/2022/10/03/Games101_13_16_RayTracing/PlaneEquation01.png" height="300px" alt="PlaneEquation01"> </div>
</li>
<li><p>即 $r(t)=o+td,0\leq t &lt; \infty$ 和 $(p-p’)·N=0$ 联立求 $t$；</p>
</li>
<li><p>之后求得点P是否在三角形内；</p>
</li>
</ul>
</li>
<li><p><strong>Möller Trumbore Algorithm</strong></p>
<ul>
<li>按传统求解，求出 $t$ 后，还需要判断 P 点是否在三角形内，较为繁琐，因此提出<strong>Möller Trumbore Algorithm</strong></li>
<li><img src="/2022/10/03/Games101_13_16_RayTracing/MollerTrumboreAlgorithm.png" alt="MollerTrumboreAlgorithm"><ul>
<li>射线$r(t)=O+tD$ ，与由<strong>重心坐标</strong>表示的三角形上的点 $P$ 求解（三个式子，三个未知量，根据克拉默必定有解）；</li>
<li>求得交点后，可通过重心坐标得知该点是否在三角形外；</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="c-2-Acclerating-Ray-Surface-Intersection"><a href="#c-2-Acclerating-Ray-Surface-Intersection" class="headerlink" title="c.2). Acclerating Ray-Surface Intersection"></a>c.2). Acclerating Ray-Surface Intersection</h3><ul>
<li><strong>原因：</strong>当需要求得光线最近的交点时，需要遍历场景所有三角面，速度慢，需要加速；</li>
</ul>
<h4 id="c-2-1-Axis-Aligned-Bounding-Box-AABB，轴对齐包围盒"><a href="#c-2-1-Axis-Aligned-Bounding-Box-AABB，轴对齐包围盒" class="headerlink" title="c.2.1). Axis-Aligned Bounding Box(AABB，轴对齐包围盒)"></a>c.2.1). Axis-Aligned Bounding Box(AABB，轴对齐包围盒)</h4><ul>
<li><p><strong>Bounding Volumes</strong></p>
<ul>
<li><strong>思想：</strong><font color="red">当物体不与包围体积相交时，更不可能和物体相交</font>；</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/BoundingVolumes.png" alt="BoundingVolumes"></p>
</li>
<li><p><strong>Bounding Box（AABB for example）：</strong></p>
<ul>
<li><strong>理解：</strong>盒子是3对对立的面的交集；</li>
<li><strong>Axis-Aligned Bounding Box(AABB)</strong><img src="/2022/10/03/Games101_13_16_RayTracing/AABB_BoundingBox.png" alt="AABB_BoundingBox"><ul>
<li><strong>AABB包围盒的面总在xy/xz/yz平面；</strong></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>光线与AABB求交：</strong></p>
<ul>
<li>2D情况下（3D同理）<img src="/2022/10/03/Games101_13_16_RayTracing/RayIntersection_with_AABB.png" alt="RayIntersection_with_AABB"></li>
<li><strong>思想：</strong><ul>
<li>光线进入Box：<strong>只有</strong>当光线进入<strong>所有</strong>的对立面；</li>
<li>光线出Box：<strong>只要</strong>光线出射<strong>一个</strong>对立面；</li>
<li>对于3D的Box，$t_{enter}=max\{t_{min}\},t_{exit}=min\{t_{max}\}$；</li>
<li>如果 $t_{enter}&lt;t_{exit}$，则光线经过Box；</li>
</ul>
</li>
<li>对于 $t_{enter}$ 和 $t_{exit}$ 正负情况的考虑：<ul>
<li>$t_{exit}&lt;0$：不相交（Box在光线后边）</li>
<li>$t_{exit}&lt;0$ and $t_{enter}&lt;0$：光线起点在盒子里，一定相交</li>
<li>当且仅当 $t_{enter}&lt;t_{exit}\quad\&amp;\&amp;\quad t_{exit}\geq0$，光线与AABB相交；</li>
</ul>
</li>
</ul>
</li>
<li>为什么使用AABB：求交方便；<img src="/2022/10/03/Games101_13_16_RayTracing/AA_reason.png" alt="AA_reason"></li>
</ul>
<h1 id="Lecture-14-amp-15-Ray-Tracing-Acceleration-amp-Radiometry-Light-Transport-amp-Global-Illumination"><a href="#Lecture-14-amp-15-Ray-Tracing-Acceleration-amp-Radiometry-Light-Transport-amp-Global-Illumination" class="headerlink" title="Lecture 14&amp;15 Ray Tracing(Acceleration &amp; Radiometry; Light Transport &amp; Global Illumination)"></a>Lecture 14&amp;15 Ray Tracing(Acceleration &amp; Radiometry; Light Transport &amp; Global Illumination)</h1><h2 id="a-Uniform-Spatial-Partitions（统一空间分区）"><a href="#a-Uniform-Spatial-Partitions（统一空间分区）" class="headerlink" title="a). Uniform Spatial Partitions（统一空间分区）"></a>a). Uniform Spatial Partitions（统一空间分区）</h2><p><img src="/2022/10/03/Games101_13_16_RayTracing/UniformSpatialPartitions00.png" alt="UniformSpatialPartitions00"></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/UniformSpatialPartitions.png" alt="UniformSpatialPartitions"></p>
<ul>
<li><p>Heuristic:</p>
<ul>
<li>#cells = C * #objs </li>
<li>C ≈ 27 in 3D</li>
</ul>
</li>
<li><p><strong>缺陷：</strong></p>
<ul>
<li>格子大小相同，浪费空间；</li>
<li>对于空间分布不均匀的场景容易造成“Teapot in a stadium” problem，浪费性能；</li>
</ul>
</li>
</ul>
<h2 id="b-Spatial-Partition"><a href="#b-Spatial-Partition" class="headerlink" title="b). Spatial Partition"></a>b). Spatial Partition</h2><ul>
<li>常见的空间划分的类型：<img src="/2022/10/03/Games101_13_16_RayTracing/SpatialPartitioningEx.png" alt="SpatialPartitioningEx"><ul>
<li>Oct-Tree（3维中是八叉树，2维中是四叉树；$2^n$叉树，n=维度）<ul>
<li>受维度影响；</li>
</ul>
</li>
<li><strong>KD-Tree</strong>；<ul>
<li>每次只划分一次，如果是三维则按x，y，z方向循环划分；</li>
</ul>
</li>
<li>BSP-Tree</li>
</ul>
</li>
</ul>
<h4 id="b-1-KD-Tree"><a href="#b-1-KD-Tree" class="headerlink" title="b.1). KD-Tree"></a>b.1). KD-Tree</h4><p><img src="/2022/10/03/Games101_13_16_RayTracing/KD_Tree_Pre_Processing.png" alt="KD_Tree_Pre_Processing"></p>
<ul>
<li><strong>预处理：</strong>对空间进行划分，对于子空间每次只划分一次（1、2、3划分省略）；<ul>
<li>树节点（Internal node）的数据结构：<ul>
<li><strong>划分轴：</strong>x-, y- , or z-axis;</li>
<li>划分位置：分割平面沿轴的坐标；（？）</li>
<li>子节点；</li>
<li><strong>不存储object</strong>；</li>
</ul>
</li>
<li><strong>叶子节点数据结构：</strong><ul>
<li>object的列表</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/KD_Tree_Traversing.png" alt="KD_Tree_Traversing"></p>
<ul>
<li><strong>过程：</strong><ul>
<li>光线和<strong>叶子节点1</strong>（为方便把$1$暂看作叶子节点，尽管个节点应该继续划分，$2,3$同理）相交，判断光线和$1$中储存的object是否相交（无相加，继续）；</li>
<li>……</li>
<li>光线和<strong>叶子节点3</strong>相交，判断光线和$1$中储存的object是否相交，相交，记录$t_{hit}$；</li>
</ul>
</li>
<li><strong>缺点：</strong><ol>
<li>预处理的过程中，物体（三角形）和网格求交难；<ul>
<li>如三角形和Box求交，有可能是一个小Box穿过三角形（被三角形“包裹”）</li>
</ul>
</li>
<li>同一个Object可能储存在多个叶子节点中；</li>
</ol>
</li>
</ul>
<h2 id="c-Bounding-Volume-Hierarchy-BVH"><a href="#c-Bounding-Volume-Hierarchy-BVH" class="headerlink" title="c). Bounding Volume Hierarchy (BVH)"></a>c). Bounding Volume Hierarchy (BVH)</h2><p><img src="/2022/10/03/Games101_13_16_RayTracing/BVH.png" alt="BVH"></p>
<ul>
<li><strong>特征：</strong>先将object分为两组，再重新计算包围盒，使得同一个obejct只会在一个叶子节点中出现；（但会造成Bounding Box空间的冗余）</li>
<li><strong>过程：</strong><ul>
<li>找到包围盒；</li>
<li>递归地将物体的集分为两个子集；</li>
<li><strong>重新计算</strong>子集的包围盒；</li>
<li>满足条件时停止；</li>
<li>储存objects到对应的叶子节点；</li>
</ul>
</li>
<li><strong>划分子节点：</strong><ul>
<li>选择一个维度去划分；</li>
<li>Heuristic #1: 选择最长的轴去划分；</li>
<li>Heuristic #2: 选择中间的object的位置去划分；（快速选择算法）</li>
</ul>
</li>
<li><strong>BVHs的数据结构：</strong><ul>
<li><strong>非叶子节点：</strong><ul>
<li>Bounding box</li>
<li>Children: pointer to child nodes</li>
</ul>
</li>
<li><strong>叶子节点：</strong><ul>
<li>Bounding box</li>
<li>List of objects</li>
</ul>
</li>
<li>Nodes represent subset of primitives in scene</li>
</ul>
</li>
<li><p><strong>BVH Traversal:</strong><img src="/2022/10/03/Games101_13_16_RayTracing/BVH_P_Code.png" alt="BVH_P_Code"></p>
</li>
<li><p><strong><font color="red">空间划分和物体划分:</font></strong><img src="/2022/10/03/Games101_13_16_RayTracing/SpatialvsObjectPartitions.png" alt="SpatialvsObjectPartitions"></p>
</li>
</ul>
<h2 id="d-Radiometry"><a href="#d-Radiometry" class="headerlink" title="d). Radiometry"></a>d). Radiometry</h2><h3 id="d-1-Radiant-Energy-and-Flux-Power"><a href="#d-1-Radiant-Energy-and-Flux-Power" class="headerlink" title="d.1). Radiant Energy and Flux(Power)"></a>d.1). Radiant Energy and Flux(Power)</h3><ul>
<li>Radiant Energy(辐射能量):<ul>
<li>Definition: Radiant energy is the energy of electromagnetic radiation. It is measured in units of joules, and denoted by the symbol: </li>
</ul>
</li>
</ul>
<script type="math/tex; mode=display">
Q[J=Joule]</script><ul>
<li><p>Flux(辐射通量):</p>
<ul>
<li>Definition: Radiant flux (power) is the energy emitted, reflected, transmitted or received, per unit time.</li>
</ul>
<script type="math/tex; mode=display">
\Phi \equiv \frac{\mathrm{d} Q}{\mathrm{~d} t}[\mathrm{~W}=\mathrm{Watt}][\operatorname{lm}=\text {lumen}]</script></li>
</ul>
<ul>
<li>Important Light Measurements of Interest<img src="/2022/10/03/Games101_13_16_RayTracing/RIR.png" alt="RIR"></li>
</ul>
<h3 id="d-2-Radiant-Intensity-辐射强度"><a href="#d-2-Radiant-Intensity-辐射强度" class="headerlink" title="d.2). Radiant Intensity(辐射强度)"></a>d.2). Radiant Intensity(辐射强度)</h3><ul>
<li><strong>定义</strong>：单位立体角上，产生的、反射的、接收的<strong>辐射通量</strong>。符号：<strong>I</strong>；单位：<strong>瓦特/sr、lm/sr、candela、cd</strong>。 <strong>立体角</strong>(solid angle)是有方向的，所以辐射强度是一个方向有关的属性</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/RadiantIntensity.png" alt="RadiantIntensity"></p>
<h4 id="d-2-1-Solid-angle"><a href="#d-2-1-Solid-angle" class="headerlink" title="d.2.1). Solid angle"></a>d.2.1). Solid angle</h4><ul>
<li><strong>角度（2D）：</strong> 弧长除以半径；<ul>
<li>$\theta={l\over r}$</li>
</ul>
</li>
<li><strong>立体角：</strong>立体角面积除以半径的平方<img src="/2022/10/03/Games101_13_16_RayTracing/SolidAngle.png" alt="SolidAngle"><ul>
<li>$\Omega=\frac{A}{r^{2}}$</li>
<li>球体的立体角为$4\pi$</li>
</ul>
</li>
</ul>
<h4 id="d-2-2-计算过程"><a href="#d-2-2-计算过程" class="headerlink" title="d.2.2). 计算过程"></a>d.2.2). 计算过程</h4><ul>
<li><p>立体角微分：</p>
<ul>
<li><div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/SolidAngle_D01.png" height="300px" alt="SolidAngle_D01"> <img src="/2022/10/03/Games101_13_16_RayTracing/SolidAngle_D02.png" height="300px" alt="SolidAngle_D02"> </div>
</li>
<li><p><strong>二重积分</strong>计算，总的立体角 = 球面上无数个单位立体角的加和，即∫∫sinθdθdφ<br>积分限也比较好理解：θ：0 → π，一个半圆弧， φ：0 → 2π，用半圆转一整圈得到球面</p>
</li>
</ul>
</li>
<li><p><strong>通常把ω当做方向向量来理解，这样比较好描述intensity</strong><img src="/2022/10/03/Games101_13_16_RayTracing/W_dirVect.png" alt="W_dirVect" style="zoom: 25%;"></p>
</li>
<li><p><strong>如果点光源向三维空间中均匀的辐射出能量，怎么描述强度？</strong><img src="/2022/10/03/Games101_13_16_RayTracing/Isotropic.png" alt="Isotropic" style="zoom:25%;"></p>
<p><strong>I = Φ / 4π</strong><br><strong>Φ</strong>：点光源单位时间内，向三维空间中辐射出的能量<br><strong>4π</strong>：整个三维空间的总立体角<br>其比值就是单位立体角上的辐射通量</p>
</li>
</ul>
<h4 id="d-2-3-Irradiance-辐照度"><a href="#d-2-3-Irradiance-辐照度" class="headerlink" title="d.2.3). Irradiance(辐照度)"></a>d.2.3). Irradiance(辐照度)</h4><ul>
<li><p><strong>定义：</strong>每单位面积（与光线垂直，Lambert’s Cosine Law）的能量<img src="/2022/10/03/Games101_13_16_RayTracing/Irradiance.png" alt="Irradiance"></p>
</li>
<li><p><strong>Lambert’s Cosine Law</strong><img src="/2022/10/03/Games101_13_16_RayTracing/LambertsCosLaw.png" alt="LambertsCosLaw"></p>
<ul>
<li>e.g. 太阳高度角造成四季变化</li>
</ul>
</li>
<li><img src="/2022/10/03/Games101_13_16_RayTracing/IrradianceFalloff.png" alt="IrradianceFalloff"><ul>
<li>随半径变大，Irradiacne变小，而radiant intensity不变；</li>
</ul>
</li>
</ul>
<h4 id="d-2-4-Radiance-辐亮度"><a href="#d-2-4-Radiance-辐亮度" class="headerlink" title="d.2.4). Radiance(辐亮度)"></a>d.2.4). Radiance(辐亮度)</h4><ul>
<li><p>介绍：</p>
<ul>
<li>Radiance是和光线有关的量；</li>
<li>渲染就是在计算radiance；</li>
</ul>
</li>
<li><p>单位：The <strong>radiance</strong>(luminance) is  the power emitted.  reflected, transmitted or receivedd by a surface, <font color="red">per unit solid angle</font>, <font color="blue">per projected unit area</font>.<img src="/2022/10/03/Games101_13_16_RayTracing/Radiance.png" alt="Radiance"></p>
</li>
<li><p><strong>理解：</strong></p>
<ul>
<li><p>Radiance定义：power <font color="red">per unit solid angle</font>, <font color="blue">per projected unit area</font>.</p>
</li>
<li><p>Irradiance: power per projected unit area</p>
</li>
<li><p>Intensity: power per solid angle </p>
<ul>
<li><p>So:</p>
<p>Radiance: Irradiance per solid angle</p>
<p>​    <strong>- Incident  Radiance</strong></p>
<p>Radiance: Intensity per projected unit area</p>
<p>​    <strong>- Exiting Radiance</strong></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Incident  Radiance: </strong>The <font color="red">irradiance</font> per unit <font color="red">solid angle</font>  <font color="blue">arriving at the surface</font><img src="/2022/10/03/Games101_13_16_RayTracing/IncidentRadiance.png" alt="IncidentRadiance"></p>
<ul>
<li>即 $\omega$ 方向的光线对于 $dA$ 的贡献；</li>
</ul>
</li>
<li><strong>Exiting Radiance: </strong>The <font color="red">intensity</font> per unit <font color="red">projected area</font>  <font color="blue">leaving the surface</font><img src="/2022/10/03/Games101_13_16_RayTracing/ExitingRadiance.png" alt="ExitingRadiance"><ul>
<li>即面积光 $dA$ ，对 $\omega$ 出射方向的贡献；</li>
</ul>
</li>
<li><strong>Irradiance vs. Radiance</strong><img src="/2022/10/03/Games101_13_16_RayTracing/IrradianceVS_radiance.png" alt="IrradianceVS_radiance"><ul>
<li>Irradiance和Radiance的区别在于方向性；</li>
<li>图中，$dA$ 的辐照度 $E(p)$ 为各方向（半圆）对 $dA$ 的贡献。$dA$ 的Radiance $L_i(p,w)$ 为入射方向 $d\omega$ 对 $dA$ 的贡献；</li>
<li>即，Irradiance $E(p)$ 是 radiance $L_i(p,w)$ 对于各个立体角的积分，$L_i(p,\omega)$ 是 $E(p)$ 方向 $\omega$ 的积分；</li>
</ul>
</li>
</ul>
<h2 id="c-BRDF-Bidirectional-Reflectance-Distribution-Function"><a href="#c-BRDF-Bidirectional-Reflectance-Distribution-Function" class="headerlink" title="c). BRDF(Bidirectional Reflectance Distribution Function)"></a>c). BRDF(Bidirectional Reflectance Distribution Function)</h2><p><strong>Ver Games101</strong></p>
<ul>
<li><strong>过程：</strong>光线照射到一点（$p$），该点吸收能量，再辐射出去；</li>
<li><strong>定义：</strong><img src="/2022/10/03/Games101_13_16_RayTracing/BRDF.png" alt="BRDF"><ul>
<li>分母：${\omega}_i$ 方向入射的radiance $L_i(x,{\omega}_i)$，被一点吸收后，辐射往各个方向的Irradiance $E_i({\omega}_i)$；</li>
<li>分子：$E_i({\omega}_i)$，对 ${\omega}_r$ 方向radiance的贡献  $L_r(x,{\omega}_r)$</li>
</ul>
</li>
</ul>
<p><strong>Ver self:</strong></p>
<ul>
<li><strong>定义：</strong>BRDF（双向反射分布函数, bidirectional reflective distribution function）， 是指当一束光从某个方向( $\vec l$ )照射到某个点($p$)上时，在某个方向上( $\vec v$ )的<code>出射辐射通量</code>占总的<code>入射辐射通量</code>的比例</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/21376124">基于物理着色：BRDF - Maple的文章 - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/380752802">关于brdf的两件小事 - Dua的文章 - 知乎</a></p>
<ul>
<li><p>可以理解对于某一微小（对立体角）出射光线<strong>ωi</strong>，某一微小入射光线<strong>ωj</strong>对其radiance的贡献；</p>
</li>
<li><p>也可以理解成某一微小入射光线<strong>ωj</strong>，弹射到某一方向的微小立体角<strong>ωi</strong>的光线强度的比值；</p>
</li>
<li><p>由于为了方便测量，不定义为radiance相除（即如果按照我们一开始对入射方向 <img src="https://www.zhihu.com/equation?tex=%5Cvec%7Bl%7D" alt="[公式]"> 微分的方式定义brdf，那么科学家们只需要使用一个极小的光源从 <img src="https://www.zhihu.com/equation?tex=%5Cvec%7Bl%7D" alt="[公式]"> 方向入射到点p，就可以测得brdf的值。但是如果定义为radiance相除，就很难输入一个填充立体角刚好等于1的光源。)正常单位为：</p>
<script type="math/tex; mode=display">
{1\over{sr}}</script></li>
</ul>
<h2 id="d-Rendering-equation"><a href="#d-Rendering-equation" class="headerlink" title="d). Rendering equation"></a>d). Rendering equation</h2><h3 id="d-1-简介"><a href="#d-1-简介" class="headerlink" title="d.1). 简介"></a>d.1). 简介</h3><ul>
<li><strong>The Reflection Equation</strong><img src="/2022/10/03/Games101_13_16_RayTracing/TheReflectionEquation.png" alt="TheReflectionEquation"><ul>
<li>$f_r(p,w_i,w_r)$ 为该点的BRDF</li>
</ul>
</li>
<li><img src="/2022/10/03/Games101_13_16_RayTracing/TheReflectionEquation02.png" alt="TheReflectionEquation02"><ul>
<li><strong>问题：</strong><ol>
<li>incoming radiance 不止来源于光源，也来源于其他反射（递归）；</li>
<li>未考虑自发光情况（加入自发光项，变为渲染方程）</li>
</ol>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong><font color="red">The Rendering Equation</font></strong><img src="/2022/10/03/Games101_13_16_RayTracing/RenderingEquation.png" alt="RenderingEquation"><ul>
<li>加入了自发光项 $L_e(p,{\omega}_o)$</li>
<li>考虑多次反射</li>
<li><strong>注意：</strong>该方程假定所有方向都是<strong><font color="red">朝外</font></strong>的；</li>
<li>$H^2$ 和 $\Omega$ 表示半球的积分域；</li>
</ul>
</li>
</ul>
<h3 id="d-2-理解"><a href="#d-2-理解" class="headerlink" title="d.2). 理解"></a>d.2). 理解</h3><ul>
<li><strong>Reflection  Equation:</strong><img src="/2022/10/03/Games101_13_16_RayTracing/ReflectionEquation.png" alt="ReflectionEquation"><ul>
<li>反射的Radiance是各个方向光源对出射方向Radiance贡献的积分；</li>
<li>未考虑光线多次弹射</li>
</ul>
</li>
<li><strong>Rendering Equation:</strong><img src="/2022/10/03/Games101_13_16_RayTracing/RenderingEquation_und.png" alt="RenderingEquation_und"><ul>
<li>考虑多次弹射，即其他物体反射的光线也会对出射方向 ${\omega}_r$ 的Radiance做出贡献；</li>
<li>对于渲染方程，只有 $L_r(x,{\omega}_r)$ 和 $L_r(x’,-{\omega}_i)$ 是未知的；</li>
</ul>
</li>
</ul>
<ul>
<li><strong>简化渲染方程：</strong><ul>
<li>Rendering Equation as Integral Equation<img src="/2022/10/03/Games101_13_16_RayTracing/RenderEq_asIntegralEq.png" alt="RenderEq_asIntegralEq"></li>
<li>Linear Operator Equation<img src="/2022/10/03/Games101_13_16_RayTracing/RE_linearOp.png" alt="RE_linearOp"><ul>
<li>$E$ 环境中自发光对应向量，$L$ Radiance对应的向量；</li>
<li>$K$  反射算子（矩阵）</li>
</ul>
</li>
</ul>
</li>
<li>对于Rendering Equation的线性形式，我们可以用以下式子逼近（类似泰勒展开）：<img src="/2022/10/03/Games101_13_16_RayTracing/Appro_RE_linear.png" alt="Appro_RE_linear"></li>
</ul>
<ul>
<li><h2 id="Rendering-Equation的线性形式对于光追的启示："><a href="#Rendering-Equation的线性形式对于光追的启示：" class="headerlink" title="Rendering Equation的线性形式对于光追的启示："></a><strong>Rendering Equation的线性形式对于光追的启示：</strong><img src="/2022/10/03/Games101_13_16_RayTracing/RayTracing_byREQL.png" alt="RayTracing_byREQL"></h2><ul>
<li>$E$ 为自发光，$KE$ 为 直接光照（即弹射一次），$K^2E$ 为间接光照（弹射两次）</li>
<li>全局光照（Global illumination, GI）：直接光照+间接光照</li>
<li>基础的光栅化只做了自发光和直接光照，即 $E$ 和 $KE$</li>
</ul>
</li>
</ul>
<ul>
<li><p>对比</p>
<div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/Comp_DI.png" height="400px" alt="Comp_DI"> <img src="/2022/10/03/Games101_13_16_RayTracing/Comp_GI_2bounce.png" height="400px" alt="Comp_GI_2bounce"> </div>

<div align="center"> <img src="/2022/10/03/Games101_13_16_RayTracing/Comp_GI_4bounce.png" height="400px" alt="Comp_GI_4bounce"> <img src="/2022/10/03/Games101_13_16_RayTracing/Comp_GI_16bounce.png" height="400px" alt="Comp_GI_16bounce"> </div>

<ul>
<li>上方玻璃灯：两次弹射时，光线从摄影机出发不能从玻璃罩中射出，因此其为黑色。而四次弹射时，光线从摄影机出发可以从玻璃罩中射出；</li>
<li>当bounce数目增大时，亮度会趋于一个值，而不会无限增大；</li>
</ul>
</li>
</ul>
<h2 id="e-Probability"><a href="#e-Probability" class="headerlink" title="e). Probability"></a>e). Probability</h2><p><img src="/2022/10/03/Games101_13_16_RayTracing/PDF.png" alt="PDF"></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/ExpectedValue.png" alt="ExpectedValue"></p>
<h1 id="Lecture-16-Ray-Tracing-4-Monte-Carlo-Path-Tracing"><a href="#Lecture-16-Ray-Tracing-4-Monte-Carlo-Path-Tracing" class="headerlink" title="Lecture 16 Ray Tracing 4 (Monte Carlo Path Tracing)"></a>Lecture 16 Ray Tracing 4 (Monte Carlo Path Tracing)</h1><h2 id="a-Monte-Carlo-Integration"><a href="#a-Monte-Carlo-Integration" class="headerlink" title="a). Monte Carlo Integration"></a>a). Monte Carlo Integration</h2><ul>
<li><p><strong>使用原因：</strong>一些函数过于复杂，因此对于特定积分域，不求不定积分，只求其积分的结果。（一种<strong>数值</strong>方法）</p>
</li>
<li><p><strong>过程：</strong>对函数的随机样本进行平均来估计函数的数值；</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MonteCarlo00.png" alt="MonteCarlo00"></p>
<ul>
<li><p><img src="/2022/10/03/Games101_13_16_RayTracing/MonteCarlo01.png" alt="MonteCarlo01"></p>
<ul>
<li>除以 $p(x_i)$ 是一种加权，因为对于积分域上样本的采样可能是<strong>不均匀随机采样</strong></li>
</ul>
</li>
<li><p><strong>均匀采样的情况：</strong></p>
<table frame="void">
    <tr>
    <td><center><img src="/2022/10/03/Games101_13_16_RayTracing/MonteCarlo_Uniform.png" alt="MonteCarlo_Uniform" height="200"></center></td>
    <td><center><img src="/2022/10/03/Games101_13_16_RayTracing/MonteCarlo_Uniform02.png" alt="MonteCarlo_Uniform02" height="200"></center></td>
    </tr>
</table>
</li>
<li><p>Some notes：</p>
<ol>
<li>采样越多，方差越小</li>
<li>如在$x$上积分，要采样$x$</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="b-Paht-Tracing"><a href="#b-Paht-Tracing" class="headerlink" title="b). Paht Tracing"></a>b). Paht Tracing</h2><h3 id="b-1-vs-Whitted-Style-Ray-Tracing"><a href="#b-1-vs-Whitted-Style-Ray-Tracing" class="headerlink" title="b.1). vs Whitted-Style Ray Tracing"></a>b.1). vs Whitted-Style Ray Tracing</h3><ul>
<li><p><strong>Whitted-Style Ray Tracing</strong></p>
<ul>
<li><p>遇到光滑物体会只会 反射/折射（择一进行）</p>
<ul>
<li><p>无法表现Glossy reflection</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/WS_Glossy.png" alt="WS_Glossy"></p>
</li>
</ul>
</li>
<li><p>遇到漫反射物体停止弹射</p>
<ul>
<li>没有Color Blooding(eg.direct illumination)，考虑不到漫反射物体之间的光线传播</li>
</ul>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/WS_Diffuse.png" alt="WS_Diffuse"></p>
</li>
</ul>
</li>
<li><p>But the <strong>rendering equation</strong> is correct</p>
<script type="math/tex; mode=display">
L_{o}\left(p, \omega_{o}\right)=L_{e}\left(p, \omega_{o}\right)+\int_{\Omega^{+}} L_{i}\left(p, \omega_{i}\right) f_{r}\left(p, \omega_{i}, \omega_{o}\right)\left(n \cdot \omega_{i}\right) \mathrm{d} \omega_{i}</script><ul>
<li>需要做的：<ol>
<li>解决半球域的定积分<ul>
<li>蒙特卡洛积分</li>
</ul>
</li>
<li>递归</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="b-2-A-Simple-Monte-Carlo-Solution-Direct-illumination"><a href="#b-2-A-Simple-Monte-Carlo-Solution-Direct-illumination" class="headerlink" title="b.2). A Simple Monte Carlo Solution(Direct illumination)"></a>b.2). A Simple Monte Carlo Solution(Direct illumination)</h3><ul>
<li><p>渲染一个<strong>Pixel（Point）</strong>，<em>当前</em> 之考虑<strong>直接光照</strong></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI.png" alt="MC_Soulution_DI"></p>
<ul>
<li><p>当 $\omega_i$ 与light相交时，计算该方向的radiance；与Box相交时，则该方向的radiance=0；</p>
<table frame="void">
    <tr>
    <td><center><img src="/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI_Fx.png" alt="MC_Soulution_DI_Fx" height="200"></center></td>
    <td><center><img src="/2022/10/03/Games101_13_16_RayTracing/MC_Soulution_DI_Fx_G.png" alt="MC_Soulution_DI_Fx_G" height="200"></center></td>
    </tr>
</table>
</li>
</ul>
</li>
<li><p><strong>P-Code</strong></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_Pcode.png" alt="MC_Pcode"></p>
</li>
</ul>
<h3 id="b-3-Global-illumination-加入递归"><a href="#b-3-Global-illumination-加入递归" class="headerlink" title="b.3). Global illumination(加入递归)"></a>b.3). Global illumination(加入递归)</h3><h4 id="b-3-1-GI-and-problems"><a href="#b-3-1-GI-and-problems" class="headerlink" title="b.3.1). GI and problems"></a>b.3.1). GI and problems</h4><ul>
<li><p><strong>P-Code</strong></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_GI.png" alt="MC_GI"></p>
<ul>
<li><p><strong>Problem1:</strong> Explosion of #rays as #bounces go up</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_GI_P1.png" alt="MC_GI_P1"></p>
<ul>
<li><p><strong>解决方法：</strong> <font color="red">N=1</font>（N=1即Path Tracing，Distributed Ray Tracing if N != 1）</p>
<ul>
<li><p>N=1会造成较多的Noise，因此采用Subpixel，即每个像素内多次采样（Samples per pixel, SPP）</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_GI_SPP.png" alt="MC_GI_SPP"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Problem2:</strong> 递归不会停止</p>
<ul>
<li><p>现实世界中，光线的弹射次数是无限的</p>
</li>
<li><p>简单地，<strong>减少弹射次数 == 减少能量</strong>；</p>
</li>
<li><p><strong>解决方法：</strong> Russian Roulette(RR, 俄罗斯轮盘赌)</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="b-3-2-Russian-Roulette-RR-俄罗斯轮盘赌"><a href="#b-3-2-Russian-Roulette-RR-俄罗斯轮盘赌" class="headerlink" title="b.3.2). Russian Roulette(RR, 俄罗斯轮盘赌)"></a>b.3.2). Russian Roulette(RR, 俄罗斯轮盘赌)</h4><p><img src="/2022/10/03/Games101_13_16_RayTracing/RR.png" alt="RR"></p>
<ul>
<li><p>先前一点的着色结果是 $L_o$，引入RR后</p>
<ul>
<li>With probability $P$, shoot a ray and return the <strong>shading result divided by P: <font color="red">Lo / P</font></strong></li>
<li>With probability $1-P$, don’t shoot a ray and you’ll get <strong><font color="red">0</font></strong></li>
</ul>
</li>
<li><p>由此可得出数学期望 $E=P \cdot\left(\frac{L_{o}}{p}\right)+(1-P) \cdot 0=L_{o}$</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/RR_Pcode.png" alt="RR_Pcode"></p>
</li>
</ul>
<h4 id="b-3-3-优化"><a href="#b-3-3-优化" class="headerlink" title="b.3.3). 优化"></a>b.3.3). 优化</h4><ul>
<li><p>计算直接光照时，如对点P向各个方向均匀采样，当光源小时，直接光照的贡献会小，造成较多的噪声；</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_Wasted.png" alt="MC_Wasted"></p>
</li>
<li><p><strong>解决方法：</strong> 换元，使渲染方程对光源面积 $A$ 进行积分，<strong>pdf = 1/A</strong></p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_dA01.png" alt="MC_dA01"></p>
<script type="math/tex; mode=display">
d \omega=\frac{d A \cos \theta^{\prime}}{\left\|x^{\prime}-x\right\|^{2}}

(Note:  \theta^{\prime} , not  \theta  )</script><ul>
<li>立体角可以看前面辐射度量学的部分</li>
</ul>
</li>
<li><p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_dA02.png" alt="MC_dA02"></p>
</li>
<li><p><strong>过程：</strong>（直接光照，间接光照分开计算）</p>
<ol>
<li><font color="blue">light source</font> (<strong>direct</strong>, no need to have RR)</li>
<li><font color="orange">other reflectors</font> (<strong>indirect</strong>, ues RR)</li>
</ol>
</li>
<li><p><strong>P-Code</strong>（未考虑遮挡）</p>
<p><img src="/2022/10/03/Games101_13_16_RayTracing/MC_优化_Pcode.png" alt="MC_优化_Pcode"></p>
</li>
<li><p><strong>遮挡</strong><img src="/2022/10/03/Games101_13_16_RayTracing/MC_优化_Pcode02.png" alt="MC_优化_Pcode02"></p>
</li>
</ul>
<hr>
<p>附上上学期做的光追（借鉴smallpt）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 采用Monte Carlo Path Tracing</span><br><span class="line">* 漫反射采用的是Lambert</span><br><span class="line">* 定义了三角面片和球体，其中三角面片可多片合成一个对象，</span><br><span class="line">* 与三角面片求交则使用克拉默法则，而基于此做条件上的修改就可构建平行四边形，因此将平行四边形也归入三角面片</span><br><span class="line">* 用平行四边形代替两个三角面片在适用且数量较多的情况下可显著提高运算效率</span><br><span class="line">* 球体求交运算量小于三角面片，因此墙壁通过大半径的球体构建</span><br><span class="line">*</span><br><span class="line">* 由于想要表现出计算过程，许多数学运算未化简，运算效率不高</span><br><span class="line">* 由于未使用BVH等方式约束，三角面片较为影响性能</span><br><span class="line">* 目前场景除墙面外中有两个球体（镜面反射以及玻璃），以及一个立方体，通过6个三角面片（平行四边形）构成</span><br><span class="line">*</span><br><span class="line">* 由于为了提高运算效率，本程序中使用的蒙特卡洛采样方向约束在朝向其他对象的方向（射线在必定与其他对象相交的范围内随机），</span><br><span class="line">* 但三角面片的约束范围较复杂，因此不支持将三角面片定义为光源</span><br><span class="line">*</span><br><span class="line">* 虽会增加噪声，为了运算效率，除了最大迭代次数，还引入经处理可使radiance的数学期望与原值相同的Russian Roulette，开始RR的次数为最大迭代次数除以2</span><br><span class="line">* </span><br><span class="line">* 由于运算量大，采样默认设置为1，如想提高运行效率可删除掉三角面片</span><br><span class="line">* </span><br><span class="line">* 绘制通过glut</span><br><span class="line">* 程序输出为ppm格式图片</span><br><span class="line">**/</span><br><span class="line">#define _CRT_SECURE_NO_WARNINGS</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;iomanip&gt;</span><br><span class="line">#include &lt;gl/glut.h&gt;</span><br><span class="line"></span><br><span class="line">#define DEPTH_MAX 10	//最大迭代次数</span><br><span class="line">#define WIDTH 512</span><br><span class="line">#define HIGHT 385</span><br><span class="line"></span><br><span class="line">double M_PI = 3.1415926535;</span><br><span class="line"></span><br><span class="line">double erand48(unsigned short xsubi[3]) &#123;</span><br><span class="line">	return (double)rand() / (double)RAND_MAX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Vec &#123;</span><br><span class="line">	double x, y, z;</span><br><span class="line">	Vec(double _x = 0, double _y = 0, double _z = 0) &#123; x = _x; y = _y; z = _z; &#125;;</span><br><span class="line"></span><br><span class="line">	Vec operator+(const Vec&amp; b) const &#123; return Vec(x + b.x, y + b.y, z + b.z); &#125;;	//加</span><br><span class="line"></span><br><span class="line">	Vec operator-(const Vec&amp; b) const &#123; return Vec(x - b.x, y - b.y, z - b.z); &#125;	//减</span><br><span class="line"></span><br><span class="line">	Vec operator*(double b) const &#123; return Vec(x * b, y * b, z * b); &#125;;	//数乘</span><br><span class="line"></span><br><span class="line">	Vec mult(const Vec&amp; b) const &#123; return Vec(x * b.x, y * b.y, z * b.z); &#125;	//数乘</span><br><span class="line"></span><br><span class="line">	Vec&amp; norm() &#123; return *this = *this * (1 / sqrt(x * x + y * y + z * z)); &#125;	//单位向量</span><br><span class="line"></span><br><span class="line">	double dot(const Vec&amp; b) const &#123; return x * b.x + y * b.y + z * b.z; &#125;	//点乘</span><br><span class="line"></span><br><span class="line">	Vec cross(const Vec&amp; b) const &#123; return Vec(y * b.z - z * b.y, z * b.x - x * b.z, x * b.y - y * b.x); &#125;	//叉乘</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Ray &#123;</span><br><span class="line">	Vec o, d;</span><br><span class="line">	Ray(Vec _o, Vec _d) : o(_o), d(_d) &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">enum Refl_t &#123;	//反射类型</span><br><span class="line">	DIFF,</span><br><span class="line">	SPEC,</span><br><span class="line">	REFR</span><br><span class="line">&#125;;</span><br><span class="line">struct MeshTriangle &#123;	// 三角面片</span><br><span class="line">	const Vec* verts;	// 顶点</span><br><span class="line">	const int* vertsIndex;	//顶点排序</span><br><span class="line">	const int numTris;	// 三角形数量</span><br><span class="line">	Vec* vertices;</span><br><span class="line">	Vec e, c;	// emission, color</span><br><span class="line">	Refl_t refl;</span><br><span class="line">	int isTriangle;</span><br><span class="line"></span><br><span class="line">	//顶点， 顶点列表（决定构建顺序以及法线正负）， 三角面片数量， emission, color， 材质， 是否是三角形（或平行四边形）</span><br><span class="line">	MeshTriangle(const Vec* _verts, const int* _vertsIndex, const int _numTris, Vec _e, Vec _c, Refl_t _refl, int _isTriangle = 1) :</span><br><span class="line">		verts(_verts), vertsIndex(_vertsIndex), numTris(_numTris), e(_e), c(_c), refl(_refl), isTriangle(_isTriangle)</span><br><span class="line">	&#123;</span><br><span class="line">		vertices = new Vec[3 * numTris];</span><br><span class="line">		for (int i = 0; i &lt; numTris; i++) &#123;</span><br><span class="line">			for (int n = 0; n &lt; 3; n++) &#123;</span><br><span class="line">				vertices[3 * i + n] = verts[vertsIndex[3 * i + n]];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	void move(int x, int y, int z) &#123;	// 方便调试</span><br><span class="line">		for (int i = 0; i &lt; 3 * numTris; i++) &#123;</span><br><span class="line">			vertices[i] = vertices[i] + Vec(x, y, z);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	double intersect(const Ray&amp; r, Vec&amp; n) const &#123;	// n返回法线</span><br><span class="line">		double tnear = 1e20;</span><br><span class="line">		double tnear_out;</span><br><span class="line">		//std::cout &lt;&lt; numTris &lt;&lt; std::endl;	//</span><br><span class="line">		Vec temp_normal;</span><br><span class="line">		double temp = 1e20;</span><br><span class="line">		bool flag = false;</span><br><span class="line">		for (int i = 0; i &lt; numTris; i++) &#123;</span><br><span class="line">			Vec&amp; v0 = vertices[3 * i];</span><br><span class="line">			Vec&amp; v1 = vertices[3 * i + 1];</span><br><span class="line">			Vec&amp; v2 = vertices[3 * i + 2];</span><br><span class="line">			/*std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; v0.x &lt;&lt; &quot;y:&quot; &lt;&lt; v0.y &lt;&lt; &quot;, z:&quot; &lt;&lt; v0.z &lt;&lt; std::endl;</span><br><span class="line">			std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; v1.x &lt;&lt; &quot;y:&quot; &lt;&lt; v1.y &lt;&lt; &quot;, z:&quot; &lt;&lt; v1.z &lt;&lt; std::endl;</span><br><span class="line">			std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; v2.x &lt;&lt; &quot;y:&quot; &lt;&lt; v2.y &lt;&lt; &quot;, z:&quot; &lt;&lt; v2.z &lt;&lt; std::endl;*/</span><br><span class="line">			Vec E1 = v1 - v0;</span><br><span class="line">			Vec E2 = v2 - v0;</span><br><span class="line"></span><br><span class="line">			n = E1.cross(E2).norm();	//三角形法线</span><br><span class="line">			Vec S = r.o - v0;</span><br><span class="line">			Vec S1 = (r.d).cross(E2);</span><br><span class="line">			Vec S2 = S.cross(E1);</span><br><span class="line">			//tnear为时间 沿着三角形方向 t的为正</span><br><span class="line">			//u,v 为重心坐标前的参数 都得为非负的还得小于1</span><br><span class="line">			double S1E1 = S1.dot(E1);</span><br><span class="line"></span><br><span class="line">			tnear = 1.0f / S1E1 * S2.dot(E2);</span><br><span class="line">			double u = 1.0f / S1E1 * S1.dot(S);</span><br><span class="line">			double v = 1.0f / S1E1 * S2.dot(r.d);</span><br><span class="line">			double k = 1 - u - v;</span><br><span class="line"></span><br><span class="line">			bool judge;</span><br><span class="line">			if (isTriangle) &#123;</span><br><span class="line">				judge = tnear &gt; 0 &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= 1 &amp;&amp; u &gt;= 0 &amp;&amp; u &lt;= 1 &amp;&amp; k &gt;= 0;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				judge = tnear &gt; 0 &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= 1 &amp;&amp; u &gt;= 0 &amp;&amp; u &lt;= 1;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (judge) &#123;	//不加k &gt;= 0 可构建平行四边形</span><br><span class="line">				if (!flag) &#123;</span><br><span class="line">					tnear_out = tnear;</span><br><span class="line">					temp_normal = n;</span><br><span class="line">					flag = true;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				if (tnear &lt; tnear_out) &#123;</span><br><span class="line">					tnear_out = tnear;</span><br><span class="line">					temp_normal = n;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (flag) &#123;</span><br><span class="line">			n = temp_normal;</span><br><span class="line"></span><br><span class="line">			//std::cout &lt;&lt; tnear_out &lt;&lt; std::endl;</span><br><span class="line">			return (tnear_out &lt; 1e20 &amp;&amp; tnear_out &gt; 0) ? tnear_out : 0;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			return 0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~MeshTriangle() &#123;</span><br><span class="line">		delete[] vertices;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Sphere &#123;</span><br><span class="line">	double rad;	// radius</span><br><span class="line">	Vec p, e, c;	// position, emission, color</span><br><span class="line">	Refl_t refl;</span><br><span class="line"></span><br><span class="line">	Sphere(double _rad, Vec _p, Vec _e, Vec _c, Refl_t _refl) :</span><br><span class="line">		rad(_rad), p(_p), e(_e), c(_c), refl(_refl) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	double intersect(const Ray&amp; r) const &#123;</span><br><span class="line">		Vec op = p - r.o;</span><br><span class="line">		double t, eps = 1e-4;</span><br><span class="line">		double b_12 = op.dot(r.d);		// -b / 2</span><br><span class="line">		double det_14 = b_12 * b_12 - op.dot(op) + rad * rad;	// det / 4</span><br><span class="line">		double det_14_sqrt = sqrt(det_14);</span><br><span class="line">		return (t = b_12 - det_14_sqrt) &gt; eps ? t : ((t = b_12 + det_14_sqrt) &gt; eps ? t : 0);</span><br><span class="line">		//if (det_14 &lt; 0) &#123;</span><br><span class="line">		//	return 0;</span><br><span class="line">		//&#125;</span><br><span class="line">		//else &#123;</span><br><span class="line">		//	t = b_12 - det_14_sqrt;</span><br><span class="line">		//	if (t &gt; eps) return t;	//考虑到浮点数的缺陷</span><br><span class="line"></span><br><span class="line">		//	t = b_12 + det_14_sqrt;</span><br><span class="line">		//	if (t &gt; eps) return t;</span><br><span class="line"></span><br><span class="line">		//	return 0;	//交点为反向延长线，不考虑</span><br><span class="line">		//&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Sphere spheres[] = &#123;//Scene: radius, position, emission, color, material</span><br><span class="line">	Sphere(1e5, Vec(1e5 + 1,40.8,81.6),  Vec(),Vec(.75,.25,.25),DIFF),//Left</span><br><span class="line">	Sphere(1e5, Vec(-1e5 + 99,40.8,81.6),Vec(),Vec(.25,.25,.75),DIFF),//Rght</span><br><span class="line">	Sphere(1e5, Vec(50,40.8, 1e5),       Vec(),Vec(.75,.75,.75),DIFF),//Back</span><br><span class="line">	Sphere(1e5, Vec(50,40.8,-1e5 + 170), Vec(),Vec(.25,.25,.25), DIFF),//Frnt</span><br><span class="line">	Sphere(1e5, Vec(50, 1e5, 81.6),      Vec(),Vec(.75,.75,.75),DIFF),//Botm</span><br><span class="line">	Sphere(1e5, Vec(50,-1e5 + 81.6,81.6),Vec(),Vec(.75,.75,.75),DIFF),//Top</span><br><span class="line">	Sphere(12,Vec(27,12.5,47),         Vec(),Vec(1,1,1) * .999, SPEC),//Mirr</span><br><span class="line">	Sphere(16.5,Vec(73,16.5,78),         Vec(),Vec(1,1,1) * .999, REFR),//Glas</span><br><span class="line">	Sphere(1.5, Vec(50,81.6 - 16.5,81.6),Vec(4,4,4) * 100,  Vec(), DIFF)  //Lite</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vec verts[8] = &#123;	//vertices</span><br><span class="line">	Vec(26, 0, 95),</span><br><span class="line">	Vec(41, 0, 90),</span><br><span class="line">	Vec(31, 0, 110),</span><br><span class="line">	Vec(46, 0, 105),</span><br><span class="line">	Vec(26, 40, 95),</span><br><span class="line">	Vec(41, 40, 90),</span><br><span class="line">	Vec(31, 40, 110),</span><br><span class="line">	Vec(46, 40, 105),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int vertsIndex[18] = &#123; 0, 4, 1,		// 顺序影响法线方向</span><br><span class="line">					1, 5, 3,</span><br><span class="line">					3, 7, 2,</span><br><span class="line">					2, 6, 0,</span><br><span class="line">					6, 7, 4,</span><br><span class="line">					2, 0, 3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//int vertsIndex[36] = &#123; 0, 4, 1,		// 顺序影响法线方向</span><br><span class="line">//					1, 4, 5,</span><br><span class="line">//					1, 5, 7,</span><br><span class="line">//					1, 7, 3,</span><br><span class="line">//					3, 7, 6,</span><br><span class="line">//					3, 6, 2,</span><br><span class="line">//					2, 6, 0,</span><br><span class="line">//					0, 6, 4,</span><br><span class="line">//					6, 7, 4,</span><br><span class="line">//					7, 5, 4,</span><br><span class="line">//					2, 0, 3,</span><br><span class="line">//					3, 0, 1,</span><br><span class="line">//					&#125;;</span><br><span class="line"></span><br><span class="line">MeshTriangle meshTriangles[] = &#123;</span><br><span class="line">	MeshTriangle(verts, vertsIndex, 6, Vec(), Vec(.25, .75, .25), DIFF, 0),</span><br><span class="line">&#125;;	//vertices, vertsIndex, numTris, emission, color, material</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int numSphere = sizeof(spheres) / sizeof(Sphere);</span><br><span class="line">int numMeshTriangle = sizeof(meshTriangles) / sizeof(MeshTriangle);</span><br><span class="line"></span><br><span class="line">inline double clamp01(double x) &#123;	//截断到01</span><br><span class="line">	return x &lt; 0 ? 0 : (x &gt; 1 ? 1 : x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline double gamma(double x, float n = 2.2) &#123;</span><br><span class="line">	return pow(clamp01(x), 1 / n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline int toInt255(double x) &#123;	//gamma取2.2, 四舍五入</span><br><span class="line">	return int(gamma(x) * 255 + .5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline void UpdateProgress(float progress)	//进度提醒</span><br><span class="line">&#123;</span><br><span class="line">	int barWidth = 70;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; &quot;[&quot;;</span><br><span class="line">	int pos = barWidth * progress;</span><br><span class="line">	for (int i = 0; i &lt; barWidth; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		if (i &lt; pos)</span><br><span class="line">			std::cout &lt;&lt; &quot;=&quot;;</span><br><span class="line">		else if (i == pos)</span><br><span class="line">			std::cout &lt;&lt; &quot;&gt;&quot;;</span><br><span class="line">		else</span><br><span class="line">			std::cout &lt;&lt; &quot; &quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//三位小数</span><br><span class="line">	std::cout &lt;&lt; &quot;] &quot; &lt;&lt; std::setiosflags(std::ios::fixed) &lt;&lt; std::setiosflags(std::ios::right) &lt;&lt; std::setprecision(3) &lt;&lt; float(progress * 100.0) &lt;&lt; &quot; %\r&quot;;</span><br><span class="line">	std::cout.flush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline bool intersect(const Ray&amp; r, double&amp; t, int&amp; id, Vec&amp; normal) &#123;	//t最短的相交, n 返回法线</span><br><span class="line">	double n = sizeof(spheres) / sizeof(Sphere) + numMeshTriangle;</span><br><span class="line">	double d;</span><br><span class="line">	double inf = t = 1e20;</span><br><span class="line">	for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">		//std::cout &lt;&lt; i &lt;&lt; std::endl;	//</span><br><span class="line">		if (i &lt; numSphere) &#123;</span><br><span class="line">			if ((d = spheres[i].intersect(r)) &amp;&amp; d &lt; t) &#123;	// 注意：不自交（真坑啊。。。）</span><br><span class="line">				t = d;</span><br><span class="line">				id = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			d = meshTriangles[i - numSphere].intersect(r, normal);</span><br><span class="line">			if (d &amp;&amp; d &lt; t) &#123;</span><br><span class="line">				//std::cout &lt;&lt; d &lt;&lt; std::endl;</span><br><span class="line">				t = d;</span><br><span class="line">				id = i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return t &lt; inf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Xi:随机种子	E：whether to include emissive color</span><br><span class="line">Vec radiance(const Ray&amp; r, int depth, unsigned short* Xi, int E = 1) &#123;</span><br><span class="line">	double t;	//与交点距离</span><br><span class="line">	int id = 0;</span><br><span class="line">	Vec temp_n;</span><br><span class="line">	if (!intersect(r, t, id, temp_n)) &#123;		//id &gt;= numSphere说明是三角面片</span><br><span class="line">		return Vec();	//miss</span><br><span class="line">	&#125;</span><br><span class="line">	//std::cout &lt;&lt; id &lt;&lt; std::endl;	//</span><br><span class="line"></span><br><span class="line">	Vec x = r.o + r.d * t;// Ray hit point</span><br><span class="line">	Vec n;	//normal(射线经过obj内部后,n为负数)</span><br><span class="line">	Vec f;</span><br><span class="line">	Refl_t obj_refl;</span><br><span class="line">	Vec obj_e;</span><br><span class="line">	if (id &lt; numSphere) &#123;</span><br><span class="line">		const Sphere&amp; obj = spheres[id];</span><br><span class="line">		n = (x - obj.p).norm();</span><br><span class="line">		f = obj.c;</span><br><span class="line">		obj_refl = obj.refl;</span><br><span class="line">		obj_e = obj.e;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		//std::cout &lt;&lt; id &lt;&lt; std::endl;</span><br><span class="line">		//if (x.x == 36) std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; x.x &lt;&lt; &quot;y:&quot; &lt;&lt; x.y &lt;&lt; &quot;, z:&quot; &lt;&lt; x.z &lt;&lt; std::endl;</span><br><span class="line">		const MeshTriangle&amp; obj = meshTriangles[id - numSphere];</span><br><span class="line">		n = temp_n.norm();</span><br><span class="line">		f = obj.c;</span><br><span class="line">		obj_refl = obj.refl;</span><br><span class="line">		obj_e = obj.e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (depth &gt; DEPTH_MAX) &#123;</span><br><span class="line"></span><br><span class="line">		return Vec();</span><br><span class="line">	&#125;</span><br><span class="line">	//Vec n = (x - obj.p).norm();	// sphere normal(射线经过obj内部后,n为负数)</span><br><span class="line">	Vec n_real = n.dot(r.d) &lt; 0 ? n : n * -1;	//sphere normal</span><br><span class="line">	//std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; f.x &lt;&lt; &quot;y:&quot; &lt;&lt; f.y &lt;&lt; &quot;, z:&quot; &lt;&lt; f.z &lt;&lt; std::endl;	//</span><br><span class="line"></span><br><span class="line">	//用rgb最大值作为Russian Roulette不终止的概率p</span><br><span class="line">	//RR适用因为p * Li * (1/p) + 0 * (1-p) = Li，即数学期望等于Li</span><br><span class="line">	double p = f.x &gt; f.y &amp;&amp; f.x &gt; f.z ? f.x : f.y &gt; f.z ? f.y : f.z;</span><br><span class="line"></span><br><span class="line">	if (++depth &gt; int(DEPTH_MAX / 2) || !p) if (erand48(Xi) &lt; p) f = f * (1.0 / p); else return obj_e * E;</span><br><span class="line"></span><br><span class="line">	//std::cout &lt;&lt; &quot;miss&quot; &lt;&lt; std::endl;</span><br><span class="line">	if (obj_refl == DIFF) &#123;</span><br><span class="line">		//std::cout &lt;&lt; &quot;DIFF&quot; &lt;&lt; std::endl;	//</span><br><span class="line">		//采用Lambert，出射方向任意，以极坐标的方式构建随机弹射光线方向</span><br><span class="line">		double r1 = 2 * M_PI * erand48(Xi);</span><br><span class="line">		double r2 = erand48(Xi);</span><br><span class="line">		double r2_sqrt = sqrt(r2);</span><br><span class="line"></span><br><span class="line">		//标准正交系</span><br><span class="line">		Vec w = n_real;</span><br><span class="line">		Vec u = ((fabs(w.x) &gt; 0.1 ? Vec(0, 1) : Vec(1)).cross(w)).norm();</span><br><span class="line">		Vec v = w.cross(u);</span><br><span class="line">		Vec d = (u * cos(r1) * r2_sqrt + v * sin(r1) * r2_sqrt + w * sqrt(1 - r2)).norm();	//Ray direction, 即path tracing， N=1的那条射线</span><br><span class="line"></span><br><span class="line">		Vec e;</span><br><span class="line">		for (int i = 0; i &lt; numSphere; i++) &#123;</span><br><span class="line">			const Sphere&amp; s = spheres[i];</span><br><span class="line">			if ((s.e.x &lt;= 0 &amp;&amp; s.e.y &lt;= 0 &amp;&amp; s.e.z &lt;= 0) || i &gt;= numSphere) continue;	//skip no radiance</span><br><span class="line"></span><br><span class="line">			Vec sw = s.p - x, su = ((fabs(sw.x) &gt; 0.1 ? Vec(0, 1) : Vec(1)).cross(sw)).norm(), sv = sw.cross(su);</span><br><span class="line"></span><br><span class="line">			//x发出射向id=i的范围内随机方向的采样射线</span><br><span class="line">			double cos_a_max = sqrt(1 - s.rad * s.rad / (x - s.p).dot(x - s.p));</span><br><span class="line">			double eps1 = erand48(Xi), eps2 = erand48(Xi);</span><br><span class="line">			//double cos_a = 1 - eps1*(1. - cos_a_max);</span><br><span class="line">			double cos_a = 1 - eps1 + eps1 * cos_a_max;</span><br><span class="line">			double sin_a = sqrt(1 - cos_a * cos_a);</span><br><span class="line">			double phi = 2 * M_PI * eps2;</span><br><span class="line">			Vec l = su * cos(phi) * sin_a + sv * sin(phi) * sin_a + sw * cos_a;</span><br><span class="line">			l.norm();</span><br><span class="line"></span><br><span class="line">			// Note: </span><br><span class="line">			// 根据Monte Carlo Integration得到相应形式的渲染方程(反射率方程)</span><br><span class="line">			// Lo(p,wo) = (1/N)*∑(i~n) &#123;(Li(p,wi)*fr(p,wi,wo)*(n*wi)) / pdf&#125;</span><br><span class="line">			// Lo:入射radiance, p:单位半球球心, wo:入射方向（微小立体角）</span><br><span class="line">			// N:取样数（光线数）, Li wi略</span><br><span class="line">			// fr:BRDF, n:法线方向</span><br><span class="line">			// pdf: 分布函数</span><br><span class="line">			// 由于采用的是path tracing N取1, Lo(p,wo) = (Li(p,wi)*fr(p,wi,wo)*(n*wi)) / pdf</span><br><span class="line">			// 当采用Lambert漫反射的BRDF可推导出为1/pi</span><br><span class="line">			// 对半球均匀采样时，pdf=1/单位半圆面积，但射线的方向是在于法线的夹角最大是a_max, 采样的区域被限定</span><br><span class="line">			// 球形对角度A(法线方向与某一点的夹角)积分， 得S = ſ 2 * pi * r*r sinA dA = abs(2 * pi * r * r * cosA), r=1</span><br><span class="line">			// 易得pdf = 1 / 球部分表面积 = 1 / (2 * pi * r * r(1-cos_a_max)) = 1 / (2 * pi * (1-cos_a_max))</span><br><span class="line">			// Lo(p,wo) = (Li(p,wi)*fr(p,wi,wo)*(n*wi)) / pdf = Li(p,wi) * (1 / pi) * cos_a * (2 * pi * (1 - cos_a_max))</span><br><span class="line">			Vec temp1;</span><br><span class="line">			if (intersect(Ray(x, l), t, id, temp1) &amp;&amp; id == i) &#123;</span><br><span class="line">				double omega = 2 * M_PI * (1 - cos_a_max);</span><br><span class="line">				e = e + f.mult(s.e * l.dot(n_real) * omega) * (1 / M_PI);</span><br><span class="line">				//std::cout &lt;&lt; e.x &lt;&lt; std::endl;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		//std::cout &lt;&lt; f.x &lt;&lt; std::endl;</span><br><span class="line">		return obj_e * E + e + f.mult(radiance(Ray(x, d), depth, Xi, 0));	//TEST:E暂时设置为0</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	else if (obj_refl == SPEC) &#123;</span><br><span class="line">		//std::cout &lt;&lt; &quot;SPEC&quot; &lt;&lt; std::endl;	//</span><br><span class="line">		return obj_e + f.mult(radiance(Ray(x, r.d - n * 2 * n.dot(r.d)), depth, Xi));</span><br><span class="line">	&#125;</span><br><span class="line">	else if (obj_refl == REFR) &#123;</span><br><span class="line">		//std::cout &lt;&lt; &quot;REFR&quot; &lt;&lt; std::endl;</span><br><span class="line">		Ray reflRay(x, r.d - n * 2 * n.dot(r.d));</span><br><span class="line">		bool into = n.dot(n_real) &gt; 0;</span><br><span class="line">		double nc = 1;//真空</span><br><span class="line">		double nt = 1.5;//玻璃</span><br><span class="line">		double nnt = into ? nc / nt : nt / nc;</span><br><span class="line">		double ddn = r.d.dot(n_real);</span><br><span class="line">		double cos2_t = 1 - nnt * nnt * (1 - ddn * ddn);	//2是平方</span><br><span class="line"></span><br><span class="line">		if (cos2_t &lt; 0) &#123;	//没有折射，发生全反射</span><br><span class="line">			return obj_e + f.mult(radiance(reflRay, depth, Xi));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Vec tdir = (r.d * nnt - n * ((into ? 1 : -1) * (ddn * nnt + sqrt(cos2_t)))).norm();</span><br><span class="line">		//考虑到计算量，采用近似算法</span><br><span class="line">		double a = nt - nc, b = nt + nc, R0 = a * a / (b * b), c = 1 - (into ? -ddn : tdir.dot(n));</span><br><span class="line">		double Re = R0 + (1 - R0) * c * c * c * c * c, Tr = 1 - Re, P = 0.25 + 0.5 * Re, RP = Re / P, TP = Tr / (1 - P);</span><br><span class="line"></span><br><span class="line">		if (depth &gt; 2) &#123;</span><br><span class="line">			if (erand48(Xi) &lt; P) &#123;	// RR</span><br><span class="line">				return obj_e + f.mult(radiance(reflRay, depth, Xi) * RP);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				return obj_e + f.mult(radiance(Ray(x, tdir), depth, Xi) * TP);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			return obj_e + f.mult(radiance(reflRay, depth, Xi) * Re + radiance(Ray(x, tdir), depth, Xi) * Tr);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vec* c = new Vec[WIDTH * HIGHT];	//图像缓存</span><br><span class="line"></span><br><span class="line">void Initial(void)</span><br><span class="line">&#123;</span><br><span class="line">	glClearColor(1.0f, 1.0f, 1.0f, 1.0f);</span><br><span class="line">	glMatrixMode(GL_PROJECTION);</span><br><span class="line">	int width = glutGet(GLUT_WINDOW_WIDTH);</span><br><span class="line">	int height = glutGet(GLUT_WINDOW_HEIGHT);</span><br><span class="line">	gluOrtho2D(0.0, width, 0.0, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void myDisplay(void) &#123;</span><br><span class="line">	glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">	glPointSize(1);</span><br><span class="line">	for (int y = 0; y &lt; HIGHT; y++) &#123;</span><br><span class="line">		for (int x = 0; x &lt; WIDTH; x++) &#123;</span><br><span class="line">			int n = (HIGHT - y - 1) * WIDTH + x;</span><br><span class="line">			glColor3f(gamma(c[n].x), gamma(c[n].y), gamma(c[n].z));</span><br><span class="line">			glBegin(GL_POINTS);</span><br><span class="line">			glVertex2f(x, y);</span><br><span class="line">			glEnd();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	glFlush();</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line">	int w = WIDTH, h = HIGHT;</span><br><span class="line">	int samples = 1;	//设置每subpixel采样数</span><br><span class="line">	//设置 camera</span><br><span class="line">	Ray cam(Vec(50, 52, 295.6), Vec(0, -0.042612, -1).norm());</span><br><span class="line">	Vec cx = Vec(w * 0.5135 / h);	//视场角</span><br><span class="line">	Vec cy = (cx.cross(cam.d)).norm() * 0.5135;</span><br><span class="line"></span><br><span class="line">	Vec r;	//摄影机射线</span><br><span class="line">	auto clock_start = clock();</span><br><span class="line">#pragma omp parallel for schedule(dynamic, 1) private(i)</span><br><span class="line"></span><br><span class="line">	meshTriangles[0].move(15, 0, 0);</span><br><span class="line">	for (int y = 0; y &lt; h; y++) &#123;</span><br><span class="line">		UpdateProgress((float)y / HIGHT);</span><br><span class="line">		unsigned short Xi[3] = &#123; 0, 0, y * y * y &#125;;</span><br><span class="line">		//设置四个子像素</span><br><span class="line">		for (unsigned short x = 0; x &lt; w; x++) &#123;</span><br><span class="line">			for (int sy = 0, i = (h - y - 1) * w + x; sy &lt; 2; sy++) &#123;</span><br><span class="line">				for (int sx = 0; sx &lt; 2; sx++, r = Vec()) &#123;</span><br><span class="line">					for (int s = 0; s &lt; samples; s++) &#123;</span><br><span class="line">						double r1 = 2 * erand48(Xi);</span><br><span class="line">						double dx = r1 &lt; 1 ? sqrt(r1) - 1 : 1 - sqrt(2 - r1);</span><br><span class="line">						double r2 = 2 * erand48(Xi);</span><br><span class="line">						//std::cout &lt;&lt; r1 &lt;&lt; &quot; &quot; &lt;&lt; r2 &lt;&lt; std::endl;</span><br><span class="line">						double dy = r2 &lt; 1 ? sqrt(r2) - 1 : 1 - sqrt(2 - r2);</span><br><span class="line">						Vec sample_direct = cx * (((dx + 0.5 + sx) / 2 + x) / w - 0.5)</span><br><span class="line">							+ cy * (((dy + 0.5 + sy) / 2 + y) / h - 0.5) + cam.d;</span><br><span class="line"></span><br><span class="line">						//std::cout &lt;&lt; r.x &lt;&lt; std::endl;</span><br><span class="line">						r = r + radiance(Ray(cam.o + sample_direct * 140, sample_direct.norm()), 0, Xi) * (1.0 / samples);</span><br><span class="line">						//std::cout &lt;&lt; &quot;x:&quot; &lt;&lt; r.x &lt;&lt; &quot;y:&quot; &lt;&lt; r.y &lt;&lt; &quot;, z:&quot; &lt;&lt;r.z &lt;&lt; std::endl;	//</span><br><span class="line">					&#125;</span><br><span class="line">					//std::cout &lt;&lt; c[i].x &lt;&lt; std::endl;	//</span><br><span class="line">					c[i] = c[i] + Vec(clamp01(r.x), clamp01(r.y), clamp01(r.z)) * 0.25;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FILE* f = fopen(&quot;test.ppm&quot;, &quot;wb&quot;);</span><br><span class="line">	fprintf(f, &quot;P3\n%d %d\n%d\n&quot;, w, h, 255);</span><br><span class="line">	for (int i = 0; i &lt; w * h; i++) &#123;</span><br><span class="line">		fprintf(f, &quot;%d %d %d &quot;, toInt255(c[i].x), toInt255(c[i].y), toInt255(c[i].z));</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(f);</span><br><span class="line">	</span><br><span class="line">	glutInit(&amp;argc, argv);</span><br><span class="line">	glutInitDisplayMode(GLUT_RGB | GLUT_SINGLE);</span><br><span class="line">	glutInitWindowPosition(100, 100);</span><br><span class="line">	glutInitWindowSize(w, h);</span><br><span class="line">	glutCreateWindow(&quot;Path Tracing&quot;);</span><br><span class="line"></span><br><span class="line">	Initial();</span><br><span class="line">	glutDisplayFunc(&amp;myDisplay);</span><br><span class="line">	glutMainLoop();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Games101/" rel="tag"># Games101</a>
              <a href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6/" rel="tag"># 图形学</a>
              <a href="/tags/Ray-Tracing/" rel="tag"># Ray-Tracing</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/02/Games101_10_12_Geometry/" rel="prev" title="Games101_10_12 Geometry">
                  <i class="fa fa-chevron-left"></i> Games101_10_12 Geometry
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/10/03/Games101_21_22_Animation/" rel="next" title="Games101_21_22 Animation">
                  Games101_21_22 Animation <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WhiteTail</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>



    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
